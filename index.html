<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script src="https://unpkg.com/n3/browser/n3.min.js"></script>
	<script type="module">
		class Vocabulary {
			static get title() { return this.property("title") }
			static get description() { return this.property("description") }
			static get useCase() { return this.property("useCase") }
			static get target() { return this.property("target") }
			static get useCaseTitle() { return this.property("useCaseTitle") }
			static get useCaseDescription() { return this.property("useCaseDescription") }
			static get comment() { return this.property("comment") }

			static property(name) {
				return N3.DataFactory.namedNode(`https://github.com/SocialCareData/ucr/schema/${name}`)
			}
		}

		class Graph {
			constructor(graph) {
				this.graph = graph
			}

			get requirements() {
				return [...this.graph.match(undefined, Vocabulary.title)]
					.map(x => x.subject)
					.map(x => new Requirement(x, this.graph))
					.sort((a, b) => b.useCases.length - a.useCases.length)
			}

			get useCases() {
				return [...this.graph.match(undefined, Vocabulary.useCaseTitle)]
					.map(x => x.subject)
					.map(x => new UseCase(x, this.graph))
					.sort((a, b) => b.requirements.length - a.requirements.length)
			}
		}

		class Requirement {
			constructor(node, graph) {
				this.node = node
				this.graph = graph
			}

			get id() {
				return this.node.id
			}

			get number() {
				return this.id.split("/").pop()
			}

			get title() {
				return [...this.graph.match(this.node, Vocabulary.title)]
					.map(x => x.object)
					.map(x => x.value)
				[0]
			}

			get description() {
				return [...this.graph.match(this.node, Vocabulary.description)]
					.map(x => x.object)
					.map(x => x.value)
				[0]
			}

			get useCases() {
				return [...this.graph.match(this.node, Vocabulary.useCase)]
					.map(x => x.object)
					.map(x => new UseCaseLink(x, this.graph))
			}
		}

		class UseCase {
			constructor(node, graph) {
				this.node = node
				this.graph = graph
			}

			get id() {
				return this.node.id
			}

			get number() {
				return this.id.split("/").pop()
			}

			get title() {
				return [...this.graph.match(this.node, Vocabulary.useCaseTitle)]
					.map(x => x.object)
					.map(x => x.value)
				[0]
			}

			get description() {
				return [...this.graph.match(this.node, Vocabulary.useCaseDescription)]
					.map(x => x.object)
					.map(x => x.value)
				[0]
			}

			get requirements() {
				return [...this.graph.match(undefined, Vocabulary.target, this.node)]
					.map(x => x.subject)
					.map(x => new UseCaseLink(x, this.graph))
			}
		}

		class UseCaseLink {
			constructor(node, graph) {
				this.node = node
				this.graph = graph
			}

			get requirement() {
				return [...this.graph.match(undefined, Vocabulary.useCase, this.node)]
					.map(x => x.subject)
					.map(x => new Requirement(x, this.graph))
				[0]
			}

			get target() {
				return [...this.graph.match(this.node, Vocabulary.target)]
					.map(x => x.object)
					.map(x => new UseCase(x, this.graph))
				[0]
			}

			get comment() {
				return [...this.graph.match(this.node, Vocabulary.comment)]
					.map(x => x.object)
					.map(x => x.value)
				[0]
			}
		}



		const response = await fetch("data.ttl")
		const text = await response.text()
		const parser = new N3.Parser
		const store = new N3.Store
		const quads = parser.parse(text)
		store.addQuads(quads)
		const g = new Graph(store)

		for (const requirement of g.requirements) {
			const li = document.getElementById("requirements").appendChild(document.createElement("li"))
			const div = li.appendChild(document.createElement("div"))
			const descriptionDiv = li.appendChild(document.createElement("div"))
			const commentDiv = li.appendChild(document.createElement("div"))

			div.innerText = `${requirement.number} - ${requirement.title} (${requirement.useCases.length})`
			li.dataset.id = requirement.id
			commentDiv.className = "comment"
			descriptionDiv.innerText = requirement.description
			descriptionDiv.className = "description"

			li.addEventListener("click", onRequirementClick)
		}

		for (const useCase of g.useCases) {
			const li = document.getElementById("useCases").appendChild(document.createElement("li"))
			const div = li.appendChild(document.createElement("div"))
			const descriptionDiv = li.appendChild(document.createElement("div"))
			const commentDiv = li.appendChild(document.createElement("div"))

			div.innerText = `${useCase.number} - ${useCase.title} (${useCase.requirements.length})`
			li.dataset.id = useCase.id
			commentDiv.className = "comment"
			descriptionDiv.innerText = useCase.description
			descriptionDiv.className = "description"

			li.addEventListener("click", onUseCaseClick)
		}

		document.addEventListener("keydown", e => {
			if (e.key === "Escape") {
				clear()
			}
		})

		function clear() {
			for (const element of document.querySelectorAll(".clicked")) {
				element.classList.remove("clicked")
			}
			for (const element of document.querySelectorAll(".filtered")) {
				element.classList.remove("filtered")
			}
			for (const element of document.querySelectorAll(".comment")) {
				element.innerText = ""
			}
		}

		function onRequirementClick() {
			clear()
			this.classList.add("clicked")
			for (const useCaseElement of document.querySelectorAll("#useCases li")) {
				for (const link of g.requirements
					.filter(x => x.id === this.dataset.id)
					.flatMap(x => x.useCases)
					.filter(x => x.target.id === useCaseElement.dataset.id)) {

					useCaseElement.classList.add("filtered")
					useCaseElement.querySelector(".comment").innerText = link.comment
				}
			}
		}

		function onUseCaseClick() {
			clear()
			this.classList.add("clicked")
			for (const requirementElement of document.querySelectorAll("#requirements li")) {
				for (const link of g.useCases
					.filter(x => x.id === this.dataset.id)
					.flatMap(x => x.requirements)
					.filter(x => x.requirement.id === requirementElement.dataset.id)) {

					requirementElement.classList.add("filtered")
					requirementElement.querySelector(".comment").innerText = link.comment
				}
			}
		}
	</script>
	<style>
		body {
			display: flex;
			margin: 0;
			height: 100vh;
			justify-content: space-between;
		}

		fieldset {
			overflow-y: auto;
			width: 50%;
		}

		ul {
			padding: 0;
		}

		li {
			list-style: none;
			cursor: pointer;
		}

			li:hover:not(.clicked) {
				background-color: lightblue;
			}

		.clicked {
			background-color: yellow
		}

		.filtered {
			background-color: lightgreen
		}

		.comment {
			font-style: italic;
			padding-left: 30px;
			font-size: 90%;
			padding-bottom: 20px;
		}

		.description {
			font-size: 90%;
			padding-left: 30px;
			display: none;
		}

		.clicked .description {
			display: block;
		}
	</style>
</head>
<body>
	<fieldset>
		<legend>Requirements</legend>
		<ul id="requirements"></ul>
	</fieldset>
	<fieldset>
		<legend>Use cases</legend>
		<ul id="useCases"></ul>
	</fieldset>
</body>
</html>
