<!DOCTYPE html>
<html>
<head>
	<title></title>
	<script src="https://unpkg.com/n3/browser/n3.min.js"></script>
	<script type="module">
		const response = await fetch("data.ttl")
		const text = await response.text()
		const parser = new N3.Parser
		const store = new N3.Store
		const quads = parser.parse(text)
		store.addQuads(quads)

		const requirements = [...store.match(undefined, p("title"))].map(q => ({
			id: q.subject.id,
			number: q.subject.id.split("/").pop(),
			title: q.object.value,
			useCaseCount: [...store.match(q.subject, p("use-case"))].length,
			description: [...[...store.match(q.subject, p("description"))].map(x => x.object.value)][0],
		}))
		for (const requirement of requirements.sort((a, b) => b.useCaseCount - a.useCaseCount)) {
			const li = document.getElementById("requirements").appendChild(document.createElement("li"))
			const div = li.appendChild(document.createElement("div"))
			const descriptionDiv = li.appendChild(document.createElement("div"))
			const commentDiv = li.appendChild(document.createElement("div"))

			div.innerText = `${requirement.number} - ${requirement.title} (${requirement.useCaseCount})`
			li.dataset.id = requirement.id
			commentDiv.className = "comment"
			descriptionDiv.innerText = requirement.description
			descriptionDiv.className = "description"

			li.addEventListener("click", onRequirementClick)
		}

		const useCaseLinks = Object.entries(Object.groupBy([...store.match(undefined, p("use-case"))].map(q => ({
			requirement: q.subject.id,
			target: [...store.match(q.object, p("target"))].map(q => q.object.id)[0],
			comment: [...store.match(q.object, p("comment"))].map(q => q.object.value)[0],
		})), i => i.requirement)).map(x => [x[0], x[1].map(t => ({ target: t.target, comment: t.comment }))]).map(x => ({
			requirement: x[0],
			useCases: x[1]
		}))

		const useCases = [...new Set([...store.match(undefined, p("useCaseTitle"))].map(q => ({
			id: q.subject.id,
			number: q.subject.id.split("/").pop(),
			title: q.object.value,
			requirementCount: [...store.match(undefined, p("target"), q.subject)]
				.map(x => [...store.match(undefined, p("use-case"), x.subject)]).length,
			description: [...[...store.match(q.subject, p("useCaseDescription"))].map(x => x.object.value)][0],
		})))]
		console.log(useCases);
		for (const useCase of useCases.sort((a, b) => b.requirementCount - a.requirementCount)) {
			const li = document.getElementById("useCases").appendChild(document.createElement("li"))
			const div = li.appendChild(document.createElement("div"))
			const descriptionDiv = li.appendChild(document.createElement("div"))
			const commentDiv = li.appendChild(document.createElement("div"))

			div.innerText = `${useCase.number} - ${useCase.title} (${useCase.requirementCount})`
			li.dataset.id = useCase.id
			commentDiv.className = "comment"
			descriptionDiv.innerText = useCase.description
			descriptionDiv.className = "description"

			li.addEventListener("click", onUseCaseClick)
		}

		document.addEventListener("keydown", e => {
			if (e.key === "Escape") {
				clear()
			}
		})

		function clear() {
			for (const element of document.querySelectorAll(".clicked")) {
				element.classList.remove("clicked")
			}
			for (const element of document.querySelectorAll(".filtered")) {
				element.classList.remove("filtered")
			}
			for (const element of document.querySelectorAll(".comment")) {
				element.innerText = ""
			}
		}

		function onRequirementClick() {
			clear()
			this.classList.add("clicked")
			for (const useCaseElement of document.querySelectorAll("#useCases li")) {
				const links = useCaseLinks
					.filter(x => x.requirement === this.dataset.id)
					.flatMap(x => x.useCases.filter(x => x.target === useCaseElement.dataset.id))
					.map(x => x.comment)
				if (links.length) {
					useCaseElement.classList.add("filtered")
					useCaseElement.querySelector(".comment").innerText = links[0]
				}
			}
		}

		function onUseCaseClick() {
			clear()
			this.classList.add("clicked")
			for (const requirementElement of document.querySelectorAll("#requirements li")) {
				const links = useCaseLinks
					.filter(x => x.useCases.some(x => x.target === this.dataset.id))
					.filter(x => x.requirement === requirementElement.dataset.id)
					.flatMap(x => x.useCases.filter(x => x.target === this.dataset.id).map(x => x.comment))

				if (links.length) {
					requirementElement.classList.add("filtered")
					requirementElement.querySelector(".comment").innerText = links[0]
				}
			}
		}

		function p(name) {
			return N3.DataFactory.namedNode(`https://github.com/SocialCareData/ucr/schema/${name}`)
		}
	</script>
	<style>
		body {
			display: flex;
			margin: 0;
			height: 100vh;
			justify-content: space-between;
		}

		fieldset {
			overflow-y: auto;
			width: 50%;
		}

		ul {
			padding: 0;
		}

		li {
			list-style: none;
			cursor: pointer;
		}

		.clicked {
			background-color: yellow
		}

		.filtered {
			background-color: lightgreen
		}

		.comment {
			font-style: italic;
			padding-left: 30px;
			font-size: 90%;
			padding-bottom: 20px;
		}

		.description {
			font-size: 90%;
			padding-left: 30px;
			display: none;
		}

		.clicked .description {
			display: block;
		}
	</style>
</head>
<body>
	<fieldset>
		<legend>Requirements</legend>
		<ul id="requirements"></ul>
	</fieldset>
	<fieldset>
		<legend>Use cases</legend>
		<ul id="useCases"></ul>
	</fieldset>
</body>
</html>